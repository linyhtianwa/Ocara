<?php
/**
 * Session缓存处理类
 * @Copyright (c) http://www.ocara.cn and http://www.ocaraframework.com All rights reserved.
 * @author Lin YiHu <linyhtianwa@163.com>
 */

namespace Ocara\Sessions;

use Ocara\Core\CacheFactory;
use Ocara\Exceptions\Exception;
use Ocara\Core\ServiceProvider;

class SessionCache extends ServiceProvider
{
    protected $prefix;
    protected $saveTime;

    /**
     * 注册服务
     * @throws Exception
     */
    public function register()
    {
        parent::register(); // TODO: Change the autogenerated stub

        $cacheName = ocConfig(array('SESSION', 'options', 'server'), CacheFactory::getDefaultServer());

        $this->container->bindSingleton('handler', function () use ($cacheName) {
            return CacheFactory::getInstance($cacheName);
        });
    }

    /**
     * 初始化
     */
    public function init()
    {
        $this->prefix = ocConfig(array('SESSION', 'options', 'location'), 'session:');
        $this->saveTime = ocConfig(array('SESSION', 'options', 'save_time'), 0);
    }

    /**
     * session打开
     * @return bool
     */
    public function open()
    {
        return is_object($this->handler);
    }

    /**
     * session关闭
     * @return bool
     */
    public function close()
    {
        return true;
    }

    /**
     * 读取session信息
     * @param $id
     * @return bool
     */
    public function read($id)
    {
        return $this->handler->get($this->prefix . $id) ?: OC_EMPTY;
    }

    /**
     * 保存session
     * @param $id
     * @param $data
     * @return bool
     */
    public function write($id, $data)
    {
        try {
            $this->handler->set($this->prefix . $id, stripslashes($data), $this->saveTime);
        } catch (\Exception $exception) {
            ocService()->error->show($exception->getMessage());
        }

        return true;
    }

    /**
     * 销毁session
     * @param string $id
     * @return bool
     */
    public function destroy($id)
    {
        return $this->handler->delete($this->prefix . $id);
    }

    /**
     * 垃圾回收
     * @param $maxlifetime
     * @return bool
     */
    public function gc($maxlifetime)
    {
        return true;
    }
}